---
title: "Analysis of Global Life Expectancy and Related Factors"
author: "Echo Chen, Andrew Kroening, Pooja Kabber, Dingkun Yang"
date: "November 23rd, 2022"
output: 
  pdf_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r load_libraries, echo=FALSE, message=FALSE, header=FALSE, warning=FALSE}
packages <- (c("table1", "ggplot2", "xtable", "pander","ggcorrplot", "tidyverse", "stargazer", "ggfortify", "caTools", "car", "corrplot", "gridExtra", "leaps", "Metrics", "reshape2", "moments", "mice", "cowplot", "caret", "AICcmodavg", "GGally", "pROC", "arm"))
# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
```

```{r read_data, echo=FALSE, message=FALSE, warning=FALSE}
df_life_expectancy <- read.csv(file = '../Datasets/Life_Expectancy_Data.csv')
df_life_expectancy <- data.frame(df_life_expectancy)
df_life_expectancy$Status <- factor(df_life_expectancy$Status)
df_life_expectancy$Year <- as.factor(df_life_expectancy$Year)
df_life_expectancy$Country <- as.factor(df_life_expectancy$Country)

df_life_expectancy_2014 <- df_life_expectancy[df_life_expectancy$Year == 2014, ]

# Splits for Q2

# Training
df_life_expectancy_2014$Status_num <- rep(0,nrow(df_life_expectancy_2014))
df_life_expectancy_2014$Status_num[df_life_expectancy_2014$Status=="Developed"] <- 1
df_life_expectancy_2014_cleaned <- na.omit(df_life_expectancy_2014)
df_life_expectancy_2014_cleaned$Income.composition.of.resources <- df_life_expectancy_2014_cleaned$Income.composition.of.resources * 100 
# FOR BETTER INTERPERTATION (IT RANGES FROM 0 TO 1), After transformation, one unit would be 1 percent***

# Testing 
df_life_expectancy_2013 <- df_life_expectancy[df_life_expectancy$Year == 2013, ]
df_life_expectancy_2013$Status_num <- rep(0,nrow(df_life_expectancy_2013))
df_life_expectancy_2013$Status_num[df_life_expectancy_2013$Status=="Developed"] <- 1
df_2013_cleaned <- na.omit(df_life_expectancy_2013)
df_2013_cleaned$Income.composition.of.resources <- df_2013_cleaned$Income.composition.of.resources * 100 
```


```{r ingest, echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
df_pop <- read_csv(file = '../Datasets/pop.csv', skip = 4)
df_pop_2014 <- df_pop[,c("Country", "2014")]
df_2014 <- merge(df_life_expectancy_2014, df_pop_2014, by = "Country")
df_2014$pop_10k <- df_2014$Population * 10000  
df_2014$pop_diff <- df_2014$pop_10k - df_2014$pop
df_2014_cleaned <- na.omit(df_2014)
names(df_2014_cleaned)[names(df_2014_cleaned)=="2014"] <- "pop"

# Testing 
df_pop_2013 <- df_pop[,c("Country", "2013")]
df_2013 <- merge(df_life_expectancy_2013, df_pop_2013, by = "Country")
# df_2013$pop_10k <- df_2013$Population * 10000  
# df_2013$pop_diff <- df_2013$pop_10k - df_2014$pop
df_2013_cleaned <- na.omit(df_2013)
names(df_2013_cleaned)[names(df_2013_cleaned)=="2013"] <- "pop"

```


# Abstract 

This analysis is conducted to understand which factors influence life expectancy and the development status of countries around the world. The dataset used for this research consists of national disease, economic, and social factors and was compiled by the World Health Organization (WHO). [Need to link to the dataset from Kaggle] To conduct the analysis, two research objectives are formulated: one prediction question and one inference question. Unique models are fit to each approach and the results are analyzed for utility. [Add a concluding punchline]

\newpage
# Introduction

This analysis uses data from the WHO to better understand the drivers of life expectancy around the globe. We also attempt to find inferential value from the data for determining the developmental status of a given country. From the two research questions we aim to improve insights into factors that drive a country's developmental status, and the population health indicators that lead to improved life expectancy.

The particular dataset for this analysis contains national-level observations of variables related to life expectancy around the globe for a period spanning the early portion of the 21st century. The complete dataset includes observations beginning in the year 2000 and ending in the year 2015. As a full dataset, there are 2,938 observations for 22 variables. Practically, each country has approximately one observation each year, averaging 183 for each of the 16 years encompassed by the data. The dataset effectively contains 20 variables for each country and year combination, covering significant disease, economic, and social factors. Below are the questions we aim to answer in this analysis:

(Cite data here)

## Reserach Questions 

### Question #1 (Prediction)

*"How did major disease, economic, and social factors impact life expectancy around the globe in 2014?"*

### Question #2 (Inference)

*"How did disease and mortality rates, along with national economic factors, contribute to a country's development status in 2014?"*

## Data

During the course of this initial rouund of EDA, the team identified a number of missing values from the dataset. These missing values included: 41x Population, 10x Hepatitis B, and 10x Schooling observations, with the large number of missing population values the most concerning. The team considered several approaches for mitigating the problems posed by this data, as it precludes a number of potentially influential countries from being included in this analysis. We considered multiple imputation as well as scholastic imputation for ways to mitigate these issues.

An alternative approach for missing data was identified as theoretically feasible early in the analysis process. Because of the national-level of our dataset, it is possible that we could find suitable replacement values from another source with high integrity in these areas, such as the World Bank, the International Monetary Fund, or the CIA World Factbook. While those sources had existing data for some of our missing values, we opt to not use them for replacement. Most replacement candidates we found did not match the surrounding data points (i.e. GDP figures for the country/year in question were not close enough to consider a match), and thus we have low-confidence that those values would be consistent with the WHO's data collection methods.

After the initial treatments to factor variables, our dataset is reduced to complete cases only and subset for the two years of interest in our analysis. We ultimately decide to preserve the original integrity of the data and bypass any available imputation methods. While there are certainly options available, the team assesses that the potential gain from the inclusion of the additional countries does not offset the possible bias or skew introduced from imputation. At the conclusion of these steps and decisions, we subset the data to make two sub-datasets: one for the year 2014 and one for the year 2013 which we will use in our second research question. These two datasets are nearly ideintical in size, with the 2014 dataset consisting of 131 observations, and the 2013 dataset having 130.

# Methods

(The general methodology of our analysis centered around the ability to draw insights from the dataset without significant transformations or imputations. - do we need this?) To analyse this data / accomplish this objective, the team began with a priori variable selection, after which we conducted exploratory data analysis (EDA) to examine the distributions of key variables. 

(A Priori variable selection)
These are the variables we selected as part of our initial a priori variable selection which included selecting the variables whose relationship with Life expectancy we were interested in:
Status + Population + Life.expectancy + Measles + Polio + HIV.AIDS + GDP + Income.composition.of.resources + BMI + Total.expenditure + percentage.expenditure + Schooling

## (Dealing with missing data)
From the EDA, missing data points were identified. Since imputing the missing values using mean or regression methods is not valid in this context where each value is for a country and using these methods may create an estimate significantly distant from the true value, we considered finding the missing data from other sources. We tried sources like (). Here we discovered that the data points for factors we had differed in these alternate datasets. Since the data collection time and methods may have been different for these sources, we did not use this method to impute the missing data. In the end we decided to drop the 52 rows with null values. At conclusion of data preparation, we subset for the year 2014, our focal point for this analysis, and the year 2013 as a testing validation dataset used in our second research question.

```{r handling_missing_data, echo=FALSE, message=FALSE, warning=FALSE}
# TODO: should we remove rows with 0 in percentage expenditure? can percentage expenditure be 0?

# complete case analysis - 183 to 131 rows
df_life_expectancy_cc_2014 <- df_life_expectancy_2014[complete.cases(df_life_expectancy_2014),]
df_life_expectancy_2014 <- df_life_expectancy_cc_2014

# stochastic imputation

# multiple imputation
```

## (Correlation and multicollinearity)
While conducting EDA, we found that a few of the variables in our data were highly correlated. To analyse this correlation, we used a correlation plot and VIF. We found that these variables were highly correlated:

1. Infant deaths and Under five deaths
2. Percentage expenditure and GDP
3. Hepatitis B and Diphtheria
4. Thinness variables ()
5. Schooling and Income composition of resources

Since percentage expenditure is highly correlated with GDP and schooling is highly correlated with income composition of resources, we dropped percentage expenditure and schooling from our initial list of apriori variables.

```{r correlation_check, echo=FALSE, fig.height=5, message=FALSE, warning=FALSE}
df_life_expectancy_2014_cor <- subset(df_life_expectancy_2014, select = -c(Country, Status, Year, Status_num))
# corrplot(cor(df_life_expectancy_2014_cor), method = "color")

mod.linear <- lm(Life.expectancy ~ ., data = subset(df_life_expectancy_2014_cor))
vifs <- data.frame(vif(mod.linear))
# ggplot(vifs, aes(y=vif.mod.linear., x=row.names(vifs))) +
#   geom_bar(aes(fill=vif.mod.linear.<5),stat="identity")+
#   scale_y_continuous(trans = "sqrt",  breaks = c(5, 10, 50, 100))+
#   geom_hline(yintercept = 5, colour = "red") +
#   ggtitle("VIF per feature") +
#   xlab("Featurs") + ylab("VIF") +
#   theme(axis.text.x=element_text(angle=20, hjust=1))+
#   theme(text = element_text(size = 18))+
#   scale_fill_brewer(palette="Dark2")

# infant deaths, under five deaths
# percentage expenditure, GDP
# Hepatitis B, Diphtheria
# thinness variables
# schooling, income composition of resources

# after checking for collinearity, removed schooling and percentage expenditure

# apriori variables
# Status + Population + Life.expectancy + Measles + Polio + HIV.AIDS + GDP + Income.composition.of.resources + BMI + Total.expenditure
```

## (EDA interpretation)
As mentioned before, this dataset has 22 variables. The categorical variable in our table is status. To understand their relation, we need to check the boxplots of life expectancy over the two categories developed and developing. We can check the boxplots to find that the life expectancy in Developed countries is higher, which means the categorical variable might be a good predictor for the model. For continuous variables, by name only, we expected the first phase and selected the ones we were interested in. Here we can find statistical evidence by checking correlation and collinearity. Based on the correlation matrix and Variance Inflation Factor (VIF).First,schooling, income, thinness, gdp and hiv all find possible linear relationships, which is also consistent with the initial prediction of the variables of interest. Then,we have to drop correlated pairs to show significantly high VIFs, and we have data shown in table 1. Our Ready data has 131 rows of observations. Including 12 variables, one categorical and 11 continuous variables, their detailed information, like mean standard diviation min and max values, can be found in table 1.Almost all of the data have significant differences between the minimum and maximum values, suggesting that the country has a significant prior wealth gap, population gap, etc. The population, GDP, and Measles all have large std, and the mean is exceptionally close to the maximum, which may lead to skewed data. We may need to check the assumptions to exclude the effect of this situation on the model.This is our data ready for model selection.

```{r eda1, echo=FALSE, results="asis", message=FALSE, warning=FALSE}
# scatterplot matrix
# ggpairs(subset(df_life_expectancy_cc_2014, select = c(Life.expectancy, GDP, Population, percentage.expenditure, Hepatitis.B, Measles, Polio, HIV.AIDS, Diphtheria, Schooling, Income.composition.of.resources)))

# boxplot matrix
life_expectancy_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Life.expectancy, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
gdp_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=GDP, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")

population_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Population, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
percentage_expenditure_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=percentage.expenditure, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hepatitis_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Hepatitis.B, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
measles_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Measles, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
polio_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Polio, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hiv_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=HIV.AIDS, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
diphtheria_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Diphtheria, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
schooling_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Schooling, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
income_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Income.composition.of.resources, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")


#gender_plot <- ggplot(airline,aes(Gender, Age))+geom_boxplot(aes(fill=Satisfaction))
plot_grid(life_expectancy_plot, gdp_plot, population_plot, percentage_expenditure_plot, hepatitis_plot, measles_plot, polio_plot, hiv_plot, diphtheria_plot, schooling_plot, income_plot, ncol=3)
```

```{r table_one, echo=FALSE, results="asis", header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
df_life_expectancy_14_subset <- subset(df_life_expectancy_2014,select = c(Status, Population, Life.expectancy, percentage.expenditure, Measles, Polio, HIV.AIDS, GDP, Schooling, Income.composition.of.resources, BMI, Total.expenditure))# select variables
stargazer(df_life_expectancy_14_subset,type = "latex", no.space = TRUE,
          report = ('vcsp*'), single.row = TRUE, header = FALSE,
          column.sep.width = "0.2pt",
          font.size = "small",
          title="Summary of Variables")
```

[Describe Table 1 - feels like we should add more variables]

# Results

## Question 1 (Prediction)

### Results
We then proceeded to model fitting. To answer the first research question, we fit a simple linear regression model with life expectancy as our response variable. We fit three models to study the relationship between the independent variables and life expectancy, including only our a priori variables, including all variables in the data and using backward stepwise selection. To find the best fit parsimonious model, we evaluated the models using adjusted R^2 and BIC. In our final model, we included the variables selected by backward stepwise selection and our a priori variables but excluded the variables with high collinearity that we discovered during EDA.

Finally, we obtain diagnostic information about the performance of our models.

```{r model1, echo=FALSE, results="asis", message=FALSE, warning=FALSE}
# model with a priori variables
# HIV, Income composition of resources, Total expenditure
mlrmod <- lm(Life.expectancy ~ Status + Population + Life.expectancy + Measles + Polio + HIV.AIDS + GDP + Income.composition.of.resources + BMI + Total.expenditure, data = df_life_expectancy_2014)
# summary(mlrmod)

# Adult mortality, total expenditure, HIV, Income composition of resources
lm1 <- lm(Life.expectancy ~ ., data = subset(df_life_expectancy_2014, select = -c(Country, Year)))
# summary(lm1)

# Same as above
m <- step(lm1, trace=FALSE, direction = 'backward')
# summary(m)

models <- list(mlrmod, lm1, m)
mod.names <- c('apriori', 'all', 'backwardstepwise')
aictab(cand.set = models, modnames = mod.names)

final_model <- lm(Life.expectancy ~ Status +Population + Measles + Polio + HIV.AIDS + GDP + Income.composition.of.resources + BMI + Total.expenditure + Adult.Mortality, data = df_life_expectancy_2014)
xtable(summary(final_model))
```

```{r model1_backward, echo=FALSE, message=FALSE, warning=FALSE}
# (?)
regfit.best <- regsubsets(Life.expectancy ~ ., data = subset(df_life_expectancy_cc_2014, select = -c(Country, Year)), nvmax = 16)
reg.summary <- summary(regfit.best)
# adjusted-R^2 with its largest value
plot(reg.summary$adjr2,xlab="Number of Variables",ylab="Adjusted Rsq",type="l")
which.max(reg.summary$adjr2)
# points(15,reg.summary$adjr2[15], col="red",cex=2,pch=20)

# BIC with its smallest value
plot(reg.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
which.min(reg.summary$bic)
# points(12,reg.summary$bic[12],col="red",cex=2,pch=20)

# backward stepwise
# regfit.bwd <- regsubsets(Life.expectancy~.,data=subset(df_life_expectancy_cc_2014, select = -c(Country, Year)),nvmax=16,method="backward")
# bwd.summary <- summary(regfit.bwd)
# 
# # bwd.summary
# plot(bwd.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
# which.min(bwd.summary$bic)
# points(12,bwd.summary$bic[12],col="red",cex=2,pch=20)
```

### Model Assessment

To check if the model that we selected follows the linear regression assumptions, we will plot the model summary plots and also interpret the F-statistic in the model results.

```{r model_assessment, echo=FALSE, message=FALSE, warning=FALSE}
par(mfrow = c(2,2))
plot(final_model)
```
(interprtation for check assumptions)
The linearity assumptions are met throughout the model. We can note that all linear regression assumptions are roughly satisfied.
- Residuals and Fitted Plots
There is no pattern in the residual plot. We can assume a linear relationship between the predictors and the outcome variables. (Linearity assumption)
- Scale-Location Plot
The residuals are equally distributed over the range of predictors. (Homogeneity assumption)
Normal Q-Q plot
All points are distributed along the reference line; again, it is good to assume that the data have the normality of the residuals. (Normality of residuals assumption)
Relationship between residuals and leverage
Any point at 0.5 kitchen distance from the boundary is influential. However, there is no significant point here. (Linearity assumption)

### (model interpretation)
We devised the final model based on the three linear models 'apriori', 'all,' and 'backward stepwise.' The variables that have a crucial impact on population longevity are status, population, Measles, Polio, and HIV.AIDS, GDP, Income.composition.of.resources, BMI, Total.expenditure, Adult.Mortality  
. According to the statistics, the first information is the residual summary statistics, and we can see that the median should be close to 0, i.e., the mean of the residuals. 3Q and 1Q should be quantitatively close to each other and symmetrically distributed, and the errors follow a Gaussian distribution.
For the second observation, Estimate, all coefficients are very small, and we may make the coefficients easier to observe by adjusting the unit size. Total.expenditure, HIV.AIDS, Income.composition.of.resources, StatusDeveloping
The larger absolute values of the coefficients for these four variables indicate that a one-unit change in these four variables would have a more severe effect on average life expectancy than the other variables, other things being equal.
Judging the p-values of these variables according to our setting of a=0.05 revealed that among them, Income.composition.of.resources, HIV.AIDS 
and Adult. Mortality is much less than 0.05 and has a very significant effect on life expectancy. Total. expenditure is close to 0.05 and is also a very important influence and somehow significant.
Finally, we can observe that by looking at R-squared: 0.8758, Adjusted R-squared 0.8654 
Our final model matches the data to a degree of 87%. In summary, our final model using ten variables has 87% accuracy in meeting all assumptions, where the most critical influences on mean life expectancy are these four variables:
- HIV.AIDS (-8.647e-01)
- Income.composition.of.resources (3.462e+01) 
- Total.expenditure(3.286e-01) 
- Adult.mortality(-1.794e-02) ranked in order.

## Question 2: (Inference)

### Results

Table XXXX: Logistic Regression Models (below) shows the output of 8 predictor variables regressed onto country development status in four models. From left to right those models are: 

1. the initial full model

2. a model with Health Expenditure/GDP per capita dropped for multicolinearity concerns

3. the potential model fit after all logistic transformations with Income Composition of Resources included

4. the final model fit after dropping Income Composition of Resources

From the model output we observe that only one predictor variable has a p-value less than 0.05 denoting it as a significant predictor: *Years of Schooling*. The interpretation of this predictor's coefficient in terms of the odds of a country being identified or labeled as a developed country is: while holding all other predictor variables constant, a one year increase in *Years of Schooling* make it 2.39 ($e^{1.05}$) times more likely that country being identified as developed country.

```{r logistic, results="asis", out.width="90%", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE}
le14_fit_full <- glm(Status_num ~ Life.expectancy + percentage.expenditure + BMI + Total.expenditure + HIV.AIDS + GDP + Income.composition.of.resources + log(pop)   + Schooling, data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_semi_final <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + GDP + Income.composition.of.resources + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_hdi <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + log(GDP) + Income.composition.of.resources + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_final <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + log(GDP) + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_final_1 <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + log(GDP) + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_one <- glm(Status_num ~ Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

# stargazer(le14_fit_full,le14_fit_semi_final, le14_fit_hdi, le14_fit_final,
stargazer(le14_fit_full,le14_fit_semi_final, le14_fit_hdi, le14_fit_final,
          dep.var.labels="Development Status",
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          report = ('vcsp*'),
          column.sep.width = "0.1pt",
          digits = 2,
          digits.extra=7,
          font.size = "small",
          title='Logistic Regression Models',
          covariate.labels=c("Life Expectancy","Health Expend. /GDP per capita", "BMI", "Gov. Expend. on Healthcare", "HIV/AIDS Deaths/1k live births", "GDP per capita","Log of GDP per capita", "Std. Income Composit. of Resources", "Log of Population","Years of Schooling"),
          type='latex')

```

We also examine multicolinearity concerns for all four model fits. From the table below it is clearly observable that the first model has significant concerns, with two variables scoring a VIF of over 10. After we remove one variable, all subsequent models are satisfactory, with no variables scoring high on this test.

```{r multicol test, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
vif_table_full <- vif(le14_fit_full)
vif_table_semi_final <- vif(le14_fit_semi_final)
vif_table_hdi <- vif(le14_fit_hdi)
vif_table_final <- vif(le14_fit_final)
vif_table_summary <- dplyr::bind_rows(vif_table_full, vif_table_semi_final,vif_table_hdi, vif_table_final)
colnames(vif_table_summary) <- c("Life Expectancy","Health Expenditure/GDP per capita", "BMI", "Health Gov. Expenditure Percentage", "HIV/AIDS Deaths/1000 live births", "GDP per capita","Std. Income composition of resources", "Log of Population" , "Years of Schooling", "Log of GDP per capita")
rownames(vif_table_summary) <- c("(1)", "(2)", "(3)", "(4)")
stargazer(vif_table_summary,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Variance Inflation Factors',
          flip=TRUE,
          type='latex'
          )

```

### Assessment

Before assessing the accuracy of the potential model fit (3rd model) for this research question, we realize the interpretation of *Income Composition of Resources* variable might be troublesome. It recorded as Human Development Index in terms of income composition of resources (index ranging from 0 to 1), however the meaning behind it is confusing. We decided to adjust the model to omit *Income Composition of Resources* variable, and try to predict the development status of each country in the dataset. Those predictions are used to build a confusion matrix, shown in the table below. From this table, we can determine the True Positive (TP), True Negative (TN), False Negative (FN), and False Positive (FP) rates by comparing predicted values and actual values. For prediction, we first use the threshold of 0.5 to classify countries as developed or developing. The accuracy of this model is approximately 91\%, with 95% Confidence Interval of within 83% ~ 95%.

```{r ConfMat, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
conf_mat <- confusionMatrix(as.factor(ifelse(fitted(le14_fit_final)>=0.5, "Developed", "Developing")), df_2014_cleaned$Status, positive = "Developed" )
# conf_mat
conf_mat_t <- matrix(c(11,5,8,105), ncol=2, byrow=TRUE)
colnames(conf_mat_t) <- c("True Developed","True Developing")
rownames(conf_mat_t) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_t,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Final Model",
          type='latex')
```


A useful tool for measuring our predictions is the Receiver Operator Characteristic (ROC) curve with the axis as Sensitivity (true positive rate) and 1 - Specificity (true negative rate). We find out the optimal prediction cut-off for year 2014 dataset is 0.232, and we can see that the area under the curve is 0.959, a very strong number. We leave the value as described because the small number of countries designated as developing in our dataset means that each missed prediction carries greater weight in this group. We observed 5 false positives and 8 false negatives in our matrix, and are satisfied with this result. 

```{r ROCFinal, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
# invisible(roc(df_life_expectancy_2014_cleaned$Status_num,fitted(le14_fit_final),plot=T,print.thres=0.5,legacy.axes=T,
#               print.auc =T,col="red3"))
invisible(roc(df_2014_cleaned$Status_num,fitted(le14_fit_final),plot=T,print.thres="best",legacy.axes=T,
              print.auc =T,col="red3"))
```


### Out-of-Sample Predictions

A final validation step for this model was to predict out-of-sample probabilities for the Year 2013 dataset using "optimal" threshold, 0.232, as mentioned above for inferring developed or developing status. The result of this experiment is shown in the table below. The accuracy of these predictions is still 0.91 with 95% Confidence Interval of being within the range of 84 ~ 95% , which is approximately the same accuracy as our training data set, and should be considered a pretty good fit.


```{r ConfMat_infer, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
df_2013_cleaned$pred<- predict(le14_fit_final, df_2013_cleaned, type="response")
conf_mat_pred <- confusionMatrix(as.factor(ifelse(df_2013_cleaned$pred>=0.232, "Developed", "Developing")), df_2013_cleaned$Status, positive = "Developed" )
# conf_mat_pred
conf_mat_pred_t <- matrix(c(16,9,3,100),ncol=2, byrow=TRUE)
colnames(conf_mat_pred_t) <- c("True Developed","True Developing")
rownames(conf_mat_pred_t) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_pred_t,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Inferring Year 2013 Data",
          type='latex')
```

```{r predpro, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="100%", fig.align='center', echo=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
ggplot(df_2013_cleaned,aes(x=Schooling, y=pred), group = Status)+
  geom_point(alpha = 0.7, aes(colour=Status))+
  geom_smooth(col="red3")+ theme_classic()+
  geom_linerange(aes(x=NULL, y=0.232, xmin=5, xmax=15), linetype="dotted")+
  # geom_hline(yintercept=0.232, linetype="dashed")+
  geom_linerange(aes(x=15, y=NULL, ymin=-0.2, ymax=0.232), linetype="dotted")+
  # geom_vline(xintercept=15, linetype="dotted")+
  annotate("text", x = 9, y = 0.28, label = "Best Threshold at 0.232", vjust = -0.5)+
  # ylim(0,1.5)+
  labs(title="Pred. Prob. of Identified as Developed vs Schooling", x= "Avg. Years of Scooling", y ="Pred. Prob. of being Developed Country")
```

As you can see from the plot above, with keeping all the other variable constant, given a country with people's average years of schooling being larger than around 15 years, we may infer that the country would be more likely identified as a developed country than developing ones. On the other hand, if a country with people's average years of schooling being lower than 15 years, according to our model, we shall infer the country as developing country.


```{r box, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="100%", fig.align='center', echo=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
ggplot(df_2013_cleaned,aes(x=Status, y=Schooling, color=Status))+
  geom_boxplot()+theme_classic()+
  labs(title="Schooling vs Country Status Boxplot", x= "Country Status", y ="Avg. Years of Scooling")
```

```{r ROCPred,include=FALSE, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=FALSE, eval=FALSE}

# Cut to save space

#Receiver Operator Characteristic (ROC) curve (Sensitivity vs 1 - Specificity) is shown below, and the Area Under the Curve (AUC) is 0.966. The fact that AUC is so close to 1 confirms that this model does a good job identifying country development status for another year, 2013.


invisible(roc(df_2013_cleaned$Status_num,df_2013_cleaned$pred,plot=T,print.thres=0.232,legacy.axes=T,
              print.auc =T,col="red3"))


```

### Final Model Evaluation

Out of curiosity, we compare the final model with a model with only one predictor variable, *Years of Schooling*. An ANOVA result surprisingly shows that two models are not statistically different in terms of "inference" accuracy. As we can see in the table below (Analysis of Deviance: Final Model vs Model w/ One Predictor Variable), the p-value being 0.07 is greater than 0.05, meaning *Years of Schooling* variable by its own is a great indicator of whether the country should be considered as developed or developing country.

```{r ANOVA, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
anova_t <- anova(le14_fit_final, le14_fit_one, test="Chisq")
stargazer(anova_t,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Analysis of Deviance: Final Model vs Model w/ One Predictor Variable',
          type='latex')
```



# Conclusion

***Describe the key takeaways from your analysis, limitations, and future work that can be done to advance knowledge in this area.***

[What is the impact of this analysis, do we think it is insightful or not?]

\newpage
# Appendix

[Presently, a dumping ground for all our images and lots until we know what we want to keep]

```{r eda, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
library(GGally)

# scatterplot matrix
ggpairs(subset(df_life_expectancy_cc_2014, select = c(Life.expectancy, GDP, Population, percentage.expenditure, Hepatitis.B, Measles, Polio, HIV.AIDS, Diphtheria, Schooling, Income.composition.of.resources)))
```

```{r eda_boxplots, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# boxplot matrix
life_expectancy_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Life.expectancy, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
gdp_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=GDP, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")

population_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Population, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
percentage_expenditure_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=percentage.expenditure, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hepatitis_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Hepatitis.B, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
measles_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Measles, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
polio_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Polio, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hiv_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=HIV.AIDS, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
diphtheria_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Diphtheria, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
schooling_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Schooling, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
income_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Income.composition.of.resources, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")


#gender_plot <- ggplot(airline,aes(Gender, Age))+geom_boxplot(aes(fill=Satisfaction))
plot_grid(life_expectancy_plot, gdp_plot, population_plot, percentage_expenditure_plot, hepatitis_plot, measles_plot, polio_plot, hiv_plot, diphtheria_plot, schooling_plot, income_plot, ncol=3)
```