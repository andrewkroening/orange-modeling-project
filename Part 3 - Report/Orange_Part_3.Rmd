---
title: "Part 3: Report"
author: "Echo Chen, Andrew Kroening, Pooja Kabber, Dingkun Yang"
output: pdf_document
date: "November 22nd, 2022"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
packages <- (c("table1", "ggplot2", "xtable", "pander","ggcorrplot", "tidyverse", "stargazer", "ggfortify", "caTools", "car", "corrplot", "gridExtra", "pROC", "arm","caret"))
# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
```

```{r read_data, echo=FALSE, include=FALSE}
df_life_expectancy <- read.csv("~/Documents/Master/Duke/2022 Fall/IDS 702/Projects/Group Project/Life Expectancy Data.csv") # Change the Path
df_life_expectancy <- data.frame(df_life_expectancy)
df_life_expectancy$Status <- factor(df_life_expectancy$Status)
# Training
df_life_expectancy_2014 <- df_life_expectancy[df_life_expectancy$Year == 2014, ]
df_life_expectancy_2014$Status_num <- rep(0,nrow(df_life_expectancy_2014))
df_life_expectancy_2014$Status_num[df_life_expectancy_2014$Status=="Developed"] <- 1
df_life_expectancy_2014_cleaned <- na.omit(df_life_expectancy_2014)
# Testing 
df_life_expectancy_2013 <- df_life_expectancy[df_life_expectancy$Year == 2013, ]
df_life_expectancy_2013$Status_num <- rep(0,nrow(df_life_expectancy_2013))
df_life_expectancy_2013$Status_num[df_life_expectancy_2013$Status=="Developed"] <- 1
df_life_expectancy_2013_cleaned <- na.omit(df_life_expectancy_2013)
```

# Report Draft

## We need to clean data, due to limitation of confusion matrix

### df_life_expectancy_2014_cleaned

### df_life_expectancy_2013_cleaned is the testing year data

#### Full Model
 \  
 
WORDS PLACEHOLDER

```{r logistic, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE}
# + GDP + Income.composition.of.resources+ Population
le14_fit_full <- glm(Status_num ~ Life.expectancy + percentage.expenditure + BMI + Total.expenditure + HIV.AIDS + GDP + Income.composition.of.resources    + Schooling , data = df_life_expectancy_2014_cleaned, family=binomial(link="logit"))
stargazer(le14_fit_full,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          report = ('vcsp*'),
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Logistic Regression Model',
          type='latex')
# summary(le14_fit_full)
```

```{r, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
vif_table <- vif(le14_fit_full)
stargazer(vif_table,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Variance Inflation Factors',
          type='latex')
```


Percentage expenditure and GDP are the ones have higher VIF being over 10, WE NEED TO DECIDE WHICH ONE TO INCLUDE IN THE MODEL


```{r ConfMat, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
conf_mat <- confusionMatrix(as.factor(ifelse(fitted(le14_fit_full)>=0.5, "Developed", "Developing")), df_life_expectancy_2014_cleaned$Status, positive = "Developed" )
#conf_mat
conf_mat_t <- matrix(c(14,5,5,107), ncol=2, byrow=TRUE)
colnames(conf_mat_t) <- c("True Developed","True Developing")
rownames(conf_mat_t) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_t,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Full Model",
          type='latex')
```


```{r ROCFull, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
invisible(roc(df_life_expectancy_2014_cleaned$Status_num,fitted(le14_fit_full),plot=T,print.thres=0.5,legacy.axes=T,
              print.auc =T,col="red3"))
```


\newpage


## Without percentage expenditure

### Model 1


```{r, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
le14_fit_1 <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + GDP + Income.composition.of.resources + Schooling , data = df_life_expectancy_2014_cleaned, family=binomial(link="logit"))
stargazer(le14_fit_1,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          report = ('vcsp*'),
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Logistic Regression Model',
          type='latex')
# summary(le14_fit_1)
```

```{r, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
vif_table_1 <- vif(le14_fit_1)
stargazer(vif_table_1,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Variance Inflation Factors',
          type='latex')
```

Income composition of resources VIF is near 5, with p-value less than 0.05 (CANNOT DELETE, but maybe delete total expenditure)


```{r ConfMat_1, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
conf_mat_1 <- confusionMatrix(as.factor(ifelse(fitted(le14_fit_1)>=0.5, "Developed", "Developing")), df_life_expectancy_2014_cleaned$Status, positive = "Developed" )
# conf_mat_1
conf_mat_t_1 <- matrix(c(14, 4, 5, 108),ncol=2, byrow=TRUE)
colnames(conf_mat_t_1) <- c("True Developed","True Developing")
rownames(conf_mat_t_1) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_t_1,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Model 1",
          type='latex')
```


```{r ROC2, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
invisible(roc(df_life_expectancy_2014_cleaned$Status_num,fitted(le14_fit_1),plot=T,print.thres=0.5,legacy.axes=T,
              print.auc =T,col="red3"))
```

## Full Model vs Model 1

```{r ANOVA1, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
anova_1 <- anova(le14_fit_full, le14_fit_1, test="Chisq")
stargazer(anova_1,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Analysis of Deviance: Full Model vs Model 1',
          type='latex')
```

\newpage

## Without GDP

### Model 2


```{r, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
le14_fit_2 <- glm(Status_num ~ Life.expectancy + BMI + percentage.expenditure + Total.expenditure + HIV.AIDS  + Income.composition.of.resources + Schooling , data = df_life_expectancy_2014_cleaned, family=binomial(link="logit"))
stargazer(le14_fit_2,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          report = ('vcsp*'),
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Logistic Regression Model',
          type='latex')
# summary(le14_fit_2)
```


```{r, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
vif_table_2 <- vif(le14_fit_2)
stargazer(vif_table_2,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Variance Inflation Factors',
          type='latex')
```

```{r ConfMat_2, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
conf_mat_2 <- confusionMatrix(as.factor(ifelse(fitted(le14_fit_2)>=0.5, "Developed", "Developing")), df_life_expectancy_2014_cleaned$Status, positive = "Developed" )
# conf_mat_2
conf_mat_t_2 <- matrix(c(14,5,5,107), ncol=2, byrow=TRUE)
colnames(conf_mat_t_2) <- c("True Developed","True Developing")
rownames(conf_mat_t_2) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_2,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Model 2",
          type='latex')
```


```{r ROC3, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
invisible(roc(df_life_expectancy_2014_cleaned$Status_num,fitted(le14_fit_2),plot=T,print.thres=0.5,legacy.axes=T,
              print.auc =T,col="red3"))
```


\newpage

## Model 1 vs Model 2

```{r ANOVA2, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
anova_2 <- anova(le14_fit_1, le14_fit_2, test="Chisq")
stargazer(anova_2,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Analysis of Deviance: Model 1 (W/O percentage expenditure) vs Model 2 (W/O GDP)',
          type='latex')
```

## Full Model vs Model 2

```{r ANOVA3, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
anova_3 <- anova(le14_fit_full, le14_fit_2, test="Chisq")
stargazer(anova_3,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Analysis of Deviance: Full Model vs Model 2',
          type='latex')
```

\newpage

###  Using Model 1 (w/o percentage expenditure) to predict out-of-sample (Year 2013) probabilities


```{r ConfusionMatrix4, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
df_life_expectancy_2013_cleaned$predprob_model_1 <- predict(le14_fit_1, df_life_expectancy_2013_cleaned, type="response")
conf_mat_3 <- confusionMatrix(as.factor(ifelse(df_life_expectancy_2013_cleaned$predprob_model_1>=0.5, "Developed", "Developing")), df_life_expectancy_2013_cleaned$Status, positive = "Developed" )
# conf_mat_3$table
# conf_mat_3
conf_mat_t_3 <- matrix(c(14,6,5,105),ncol=2, byrow=TRUE)
colnames(conf_mat_t_3) <- c("True Developed","True Developing")
rownames(conf_mat_t_3) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_t_3,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix 4",
          type='latex')
```


###  Using Model 2 (w/o GDP) to predict out-of-sampl e(Year 2013) probabilities


```{r ConfusionMatrix5, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
df_life_expectancy_2013_cleaned$predprob_model_2 <- predict(le14_fit_2, df_life_expectancy_2013_cleaned, type="response")
conf_mat_4 <- confusionMatrix(as.factor(ifelse(df_life_expectancy_2013_cleaned$predprob_model_2>=0.5, "Developed", "Developing")), df_life_expectancy_2013_cleaned$Status, positive = "Developed" )
# conf_mat_4$table
# conf_mat_4
conf_mat_t_4 <- matrix(c(14,5,5,106),ncol=2, byrow=TRUE)
colnames(conf_mat_t_4) <- c("True Developed","True Developing")
rownames(conf_mat_t_4) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_t_4,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix 5",
          type='latex')
```


Model 2 is slightly better, numerical wise. But not statistically different than Model 1


\newpage


# Tested, not good

## Without Total Expenditure and percentage expenditure.

### Model 3


```{r, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
le14_fit_3 <- glm(Status_num ~ Life.expectancy + BMI  + HIV.AIDS  + Income.composition.of.resources + Schooling , data = df_life_expectancy_2014_cleaned, family=binomial(link="logit"))
stargazer(le14_fit_3,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          report = ('vcsp*'),
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Logistic Regression Model',
          type='latex')
# summary(le14_fit_3)
```


```{r, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
vif_table_3 <- vif(le14_fit_3)
stargazer(vif_table_3,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Variance Inflation Factors',
          type='latex')
```

```{r ConfMat_3, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
conf_mat_3 <- confusionMatrix(as.factor(ifelse(fitted(le14_fit_3)>=0.5, "Developed", "Developing")), df_life_expectancy_2014_cleaned$Status, positive = "Developed" )
# conf_mat_3
conf_mat_t_3 <- matrix(c(13,4,6,108), ncol=2, byrow=TRUE)
colnames(conf_mat_t_3) <- c("True Developed","True Developing")
rownames(conf_mat_t_3) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_3,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Model 3",
          type='latex')
```


```{r ROC4, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
invisible(roc(df_life_expectancy_2014_cleaned$Status_num,fitted(le14_fit_3),plot=T,print.thres=0.5,legacy.axes=T,
              print.auc =T,col="red3"))
```


\newpage

## Model 1 vs Model 3

```{r ANOVA4, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
anova_2 <- anova(le14_fit_1, le14_fit_3, test="Chisq")
stargazer(anova_2,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Analysis of Deviance: Model 1 vs Model 3',
          type='latex')
```

## Full Model vs Model 3

```{r ANOVA5, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
anova_3 <- anova(le14_fit_full, le14_fit_3, test="Chisq")
stargazer(anova_3,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Analysis of Deviance: Full Model vs Model 3',
          type='latex')
```
