---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(corrplot)
library(leaps)
library(car)
library(Metrics)
library(reshape2)
library(ggpubr)
library(moments)
```
#1. plot to see relationship 
@ Pooja
```{r,fig.width=10,fig.height=4}
data_org <- read.csv(file = 'Life_Expectancy_Data.csv')
data<-df_life_expectancy[data_org$Year == 2014, ]
data <- subset(data, select = -c(Country, Year))
data$Status <- as.factor(data$Status)
copy_data<- data
data <- as.data.frame(scale(subset(data,select = -c(Status)), scale=TRUE, center = TRUE))
data$Status <- copy_data$Status
data_FULL <- data
mod.linear <- lm(Life.expectancy~ ., data = subset(data,select =-c(Status)))
vifs <- data.frame(vif(mod.linear))
# plot go tp appendix
ggplot(vifs, aes(y=vif.mod.linear., x=row.names(vifs))) + 
    geom_bar(aes(fill=vif.mod.linear.>5),stat="identity")+
    scale_y_continuous(trans = "sqrt",  breaks = c(5, 10, 50, 100))+
    geom_hline(yintercept = 5, colour = "red") + 
    ggtitle("VIF per feature") +
    xlab("Featurs") + ylab("VIF") +
    theme(axis.text.x=element_text(angle=20, hjust=1))+
    theme(text = element_text(size = 18))+
    scale_fill_brewer(palette="Dark2")
```
```{r,fig.width=10,fig.height=4}
# reduced correlation matrix
data_EDA <- subset(data, select = -c(infant.deaths))
data_EDA <- subset(data_EDA, select = -c(GDP))
data_EDA <- subset(data_EDA, select = -c(thinness..1.19.years))
corr <- round(cor(subset(data_EDA, select =-c(Status))), 3)
ggcorrplot(corr,type = "upper", lab = TRUE, outline.color = "black", lab_size = 4, legend.title = "Correlation")
```
```{r,fig.width=10,fig.height=4}
mod.linear <- lm(Life.expectancy~ ., data = subset(data_EDA, select =-c(Status)))
vifs <- data.frame(vif(mod.linear))

ggplot(vifs, aes(y=vif.mod.linear., x=row.names(vifs))) + 
    geom_bar(aes(fill=vif.mod.linear.<5),stat="identity")+
    scale_y_continuous(trans = "sqrt",  breaks = c(5, 10, 50, 100))+
    geom_hline(yintercept = 5, colour = "red") + 
    ggtitle("VIF per feature") +
    xlab("Featurs") + ylab("VIF") +
    theme(axis.text.x=element_text(angle=20, hjust=1))+
    theme(text = element_text(size = 18))+
    scale_fill_brewer(palette="Dark2")
```

## 3. choose variables( R & BIC )
```{r}
# plot 
regfit.best <- regsubsets(Life.expectancy~., data= data_EDA, nvmax = 16)
reg.summary <- summary(regfit.best)
# adjusted-R^2 with its largest value
plot(reg.summary$adjr2,xlab="Number of Variables",ylab="Adjusted Rsq",type="l")
which.max(reg.summary$adjr2)
points(15,reg.summary$adjr2[15], col="red",cex=2,pch=20)

# BIC with its smallest value
plot(reg.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
which.min(reg.summary$bic)
points(12,reg.summary$bic[12],col="red",cex=2,pch=20)
# backward
regfit.bwd <- regsubsets(Life.expectancy~.,data=data_EDA,nvmax=16,method="backward")
bwd.summary <- summary(regfit.bwd)

# bwd.summary
plot(bwd.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
which.min(bwd.summary$bic)
points(12,bwd.summary$bic[12],col="red",cex=2,pch=20)
```

## 4. transformation (missing & skewed)
@ echo fifth
@ Pooja first 


```{r}
library(mice)
data.imp<- mice(train, m = 5, method = 'pmm')
mod1<-with(data.imp, lm(Life.expectancy~.))
pool(mod1)
```

## 5. select model (check asumptions)
```{r}
data_FS <- subset(data_EDA, select=c(Life.expectancy,Status, Adult.Mortality, percentage.expenditure,
                                     Hepatitis.B, Polio, BMI, thinness.5.9.years, Measles,
                                     Diphtheria,HIV.AIDS,Income.composition.of.resources,Schooling))
set.seed(123)

sample <- sample(c(TRUE, FALSE), nrow(data_FULL), replace=TRUE, prob=c(0.70,0.30))
train <- data_FULL[sample, ]
x.test <-data_FULL[!sample, ]
y.test <- data_FULL[!sample, ]$Life.expectancy
model.full<- lm(Life.expectancy~., data = train)
summary(model.full)
```
The linearity assumptions are met for the full model We can notice that all linear regression assumptions are roughly met:

- The Residuals vs Fitted plot

There is no pattern in the residual plot. we can assume linear relationship between the predictors and the outcome variables. (linearity assumption)

- The Scale-Location plot

The residuals are spread equally across the ranges of predictors. (homoscedasticity assumption)

The Normal Q-Q plot
All the points spread along the reference line equally, itâ€™s good enough to assume that the data has the normality of the residuals.(normality of the residuals assumption)

The Residuals vs Leverage
Any point in the 0.5 cook distance boundary are influential. However, there are no influential points here. (linearity assumption)

## 6.models with conclusions

```{r}
set.seed(123)

sample <- sample(c(TRUE, FALSE), nrow(data_FS), replace=TRUE, prob=c(0.70,0.30))
train <- data_FS[sample, ]
x.test <-data_FS[!sample, ]
y.test <- data_FS[!sample, ]$Life.expectancy
model.FS <- lm(Life.expectancy~., data = train)
summary(model.FS)

# cheack assumption
pred <- predict(model.FS, newdata=x.test)
rmse(pred,y.test)
summary(model.FS)$adj.r.squared
par(mfrow=c(2,2))
plot(model.FS)
```
